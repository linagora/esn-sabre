#
# minimal compose infrastucture for testing
#
services:
  mongodb:
    image: docker.io/library/mongo:3.4.0
    hostname: mongodb
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - esn-sabre-test-net

  amqp_host:
    image: docker.io/library/rabbitmq:3
    hostname: amqp_host
    healthcheck:
      test: ["CMD", "rabbitmqctl", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - esn-sabre-test-net

  esn_ldap:
    image: esn-sabre-ldap-test
    hostname: esn_ldap
    environment:
      - LDAP_PORT_NUMBER=389
      - LDAP_ADMIN_USERNAME=admin
      - LDAP_ADMIN_PASSWORD=admin
      - LDAP_ROOT=dc=linagora.com,dc=lng
      - BITNAMI_DEBUG=true
    networks:
      - esn-sabre-test-net

  esn_test:
    image: esn_sabre_test
    hostname: esn_sabre_test
    environment:
      - LDAP_ADMIN_DN=cn=admin,dc=linagora.com,dc=lng
      - LDAP_ADMIN_PASSWORD=admin
      - LDAP_BASE=ou=users,dc=linagora.com,dc=lng
      - LDAP_BASE_WITH_MAIL=ou=users,dc=linagora.com,dc=lng
      - LDAP_SERVER=ldap://esn_ldap:389
      - LDAP_USERNAME_MODE=username
    working_dir: /var/www
    networks:
      - esn-sabre-test-net
    command: bash -c "sleep 5 && make lint && make test"
    depends_on:
      esn_ldap:
        condition: service_started
      mongodb:
        condition: service_healthy
      amqp_host:
        condition: service_healthy

networks:
  esn-sabre-test-net:
    driver: bridge

